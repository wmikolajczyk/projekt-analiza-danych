---
title: "Projekt analiza danych"
author: "Wojciech Mikołajczyk"
date: "December 2, 2017"
output: 
  github_document:
    toc: true
    hard_line_breaks: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### TODO: rozdział podsumowujący analizę

### Wykorzystane biblioteki
```{r load libraries, message=FALSE}
library(dplyr)
library(ggplot2)
library(reshape2)
library(caret)
```

### Wczytanie danych z pliku
```{r load data, cache=TRUE}
data <- read.csv('elektrownie.csv')
```

### Krótkie podsumowanie danych w zbiorze

##### Sprawdzenie czy zbiór danych zawiera wartości NA
```{r}
any(is.na(data))
```

Liczba wartości zerowych w kolumnach
```{r}
sapply(data, function(x) sum(x==0))
```

##### Podstawowe statystyki
```{r short datasummary}
summary(data)
```
##### Liczba wierszy danych
```{r}
nrow(data)
```

##### Liczba kolumn
```{r}
ncol(data)
```
##### Typy kolumn
```{r}
pander::pander(sapply(data, class))
```

##### Liczba różnych wartości kolumn
```{r}
pander::pander(sapply(data, function(x) length(unique(x))))
```

##### Rozkład wartości poszczególnych atrybutów
```{r fig.width=9, fig.height=18, cache=TRUE}
ggplot(data = melt(data), mapping = aes(x = value)) + 
  geom_histogram(bins=50) + 
  labs(title = "Rozkład wartości atrybutów") + 
  facet_wrap(~variable, ncol=4, scales = 'free_x') + 
  scale_x_continuous(labels = scales::comma) + 
  theme_bw()
```

### Opis kolumn
Dane są z ogniw fotowoltaicznych umieszczonych we Włoszech, to tłumaczy dlaczego część kolumn w pliku z danymi ma włoskie nazwy.  
Zbiór danych opisany jest przy użyciu 51 kolumn.  
Wszystkie kolumny poza kolumnami 'id', 'data' oraz 'anno' mają wartości liczbowe i są znormalizowane.  

id - identyfikator  
idsito - id miejsca  
idmodel - id modelu  
idbrand - id marki  

idsito, idmodel i idbrand są znormalizowanymi identyfikatorami miejsca modelu i marki  
liczba różnych wartości jakie przyjmują:
```{r}
sapply(data[, names(data) %in% c('idsito', 'idmodel', 'idbrand')], function(x) length(unique(x)))
```
Jest 17 jednostek fotowoltaicznych z których są zebrane pomiary, każda z nich opisana jest marką i modelem oraz wiekiem w miesiącach
idsito, idmodel, idbrand, lat, lon, ageinmonths - opisją ogniwa fotowoltaiczne. Wartości są znormalizowane 

lat - lattitude, szerokość geograficzna ogniwa fotowoltaicznego  
lon - longitude, długość geograficzna ogniwa fotowoltaicznego  
ageinmonths - wiek ogniwa fotowoltaicznego  
anno - rok  
day - dzien (przyjmuje 365 różnych wartości, więc wszystko się zgadza)  
ora - teraz (0 dla godz. 2:00, rośnie do 1 dla godz 20:00 czyli końca pomiarów)
data - data i czas w formacie MM/DD/YYYY HH:MM, od 1/2/2012 2:00 do 12/31/2013 20:00  
pomiary są zapisane od 2:00 do 20:00 - dlaczego? przecież latem słońce świeci dłużej  
można uzyskać ilość energii wytworzonej w ciągu godziny poprzez grupowanie po dacie (suma wartości z kolumny kwh)  
dlaczego jest 17 wpisów na jedną godzinę? "Każdy wiersz w zbiorze danych zawiera uśrednione informacje z jednej godziny pomiarów pojedynczej jednostki fotowoltaicznej" - dlatego, że jest w sumie 17 jednostek (idsito)
temperatura_ambiente - temperatura otoczenia, spodziewamy się, że to może wpływać na wytwarzaną ilość energii  
irradiamento - promieniowanie, zera są możliwe - może być noc, ogniwo może być w cieniu  
pressure - ciśnienie, tutaj nie powinno być wartości 0, uzupełnione będzie średnią  
windspeed - prędkość wiatru, bardzo mało wartości zerowych, możliwe jest że nie było wiatru, zostawiamy wartości 0  
humidity - wilgotność  
icon - ikona ?  
dewpoint - temperatura punktu rosy (znormalizowana)  
windbearing - łożysko wiatrowe ?  
cloud cover - zachmurzenie, może być zerowe, zostawiamy wartości 0  
tempi -> cloudcoveri - duplikacja kolumn temperatura_ambiente -> cloudcover tylko kolumny nazwane po włosku? - inne wartości, dodane 'i' na końcu - co oznacza ?    
dist - distance ?  
altitude - wysokość  
azimuth - azymut  
altitudei -> azimuthi - odpowiedniki włoskie altitude i azimuth - inne wartości  
pcnm1 -> pcnm15 - jakieś pomiary z jakichś czujników, mają tyle samo zer ile idsito i idmodel (wyjątkiem jest pcnm13) co może wskazywać że są powiązane z czujnikami, odpowiednim ogniwom odpowiadają powtarzające się wartości  
irr_pvgis_mod - ?  
irri_pvgis_mod - ?  
kwh - wytworzone Kilowatogodziny (wartości znormalizowane)  

### Brakujące wartości - ciągi 0 w różnych kolumnach, tylko pressure
```{r}
data$pressure <- ifelse(data$pressure == 0, mean(data$pressure), data$pressure)
```

##### Przetworzenie daty na wartość liczbową
```{r}
data2 <- data
data2$data <- as.numeric(as.POSIXct(data2$data, format="%m/%d/%Y %H:%M"))
```

### Korelacja między zmiennymi
Odfiltrowanie daty, aby zostały same numeryczne wartości  
Macierz korelacji jest symetryczna, więc dla czytelności usuwamy górny trójkąt
```{r fig.width=9, fig.height=9, cache=TRUE}
correlations <- round(cor(data2), 2)
correlations[upper.tri(correlations)] <- NA
correlations_melt <- melt(correlations, na.rm = TRUE)

ggplot(data = correlations_melt, aes(Var1, Var2, fill = value)) + 
  geom_tile(color = "white") + 
  labs(title = "Korelacja atrybutów", x = "Atrybuty", y = "Wartość korelacji") + 
  scale_fill_gradient2(low="blue", mid="white", high="red", midpoint=0, limit=c(-1,1)) + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 70, size = 8, vjust = 1, hjust = 1)) +
  coord_fixed()
```

##### Kolejny wykres korelacji - tym razem tylko dla skorelowanych dodanio / ujmenie powyżej pewnego progu
```{r fig.width=9, fig.height=9, cache=TRUE}
top_correlatinons <- correlations_melt %>% filter(abs(value) > 0.3, Var1 != Var2)
ggplot(data = top_correlatinons, aes(Var1, Var2, fill = value)) + 
  geom_tile(color = "white") + 
  labs(title = "Korelacja atrybutów powyżej progu korelacji", x = "Atrybuty", y = "Wartość korelacji") + 
  scale_fill_gradient2(low="blue", mid="white", high="red", midpoint=0, limit=c(-1,1)) + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 70, size = 8, vjust = 1, hjust = 1)) +
  coord_fixed()
```

##### Kolejny wykres korelacji - korelacja atrybutów do kwh
```{r fig.width=9, fig.height=9, cache=TRUE}
kwh_correlations <- melt(correlations['kwh', ])
ggplot(data = kwh_correlations, mapping = aes(x=rownames(kwh_correlations), y=value)) + 
  geom_bar(stat="identity") + 
  labs(title = "Korelacja do atrybutu kwh", x = "Atrybuty", y = "Wartość korelacji") + 
  coord_flip() + 
  theme_bw()
```

##### Wykres - zamiana energii w czasie i przestrzeni
Zmiana daty na rok-miesiac
```{r fig.width=9, fig.height=9, cache=TRUE}
data <- data %>% 
  rename(date=data) %>% 
  mutate(date_year_month=format(as.POSIXct(date, format='%m/%d/%Y %H:%M'), "%Y-%m"))

data2 <- data %>% group_by(date_year_month, idsito) %>% summarise(sum_kwh=sum(kwh))
ggplot(data = data2, mapping = aes(x=date_year_month, y=sum_kwh, color=factor(idsito))) + 
  geom_point() +
  labs(title = "Wykres energii w czasie dla ogniw", x = "Data", y = "Suma wytworzonej energii[kwh]")
```


